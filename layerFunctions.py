from qgis.core import QgsFeatureRequest
from qgis.utils import iface



def getFeatures(layer,field,value):
    e = '%s=%s '%(doubleQuote(field),singleQuote(value))
    request = QgsFeatureRequest().setFilterExpression(e)
    return [f for f in layer.getFeatures(request)]


def getFeature(layer,field,value):
    e = '%s=%s '%(doubleQuote(field),singleQuote(value))
    request = QgsFeatureRequest().setFilterExpression(e)

    r = [f for f in layer.getFeatures(request)]
    
    if len(r)==0:
        raise KeyError('No feature with {field} ={value}'.format(field=field,value=value))

    if len(r)>1:
        raise KeyError('Multiple features with {field} ={value}'.format(field=field,value=value))

    return r[0]




def filterString(field,value):
    return '%s=%s '%(doubleQuote(field),singleQuote(value))


def singleQuote(s):
    return "'%s'"%(s)


def doubleQuote(s):
    return '"%s"'%(s)


def zoomToSelected(layer):
    a = iface.activeLayer()
    iface.setActiveLayer(layer)
    iface.actionZoomToSelected().trigger()
    iface.setActiveLayer(a)


#gets features of layer contained by geom

def containedFeatures(geom,layer):
    e = "contains(geom_from_wkt('{wkt}'),$geometry)".format(wkt=geom.asWkt())
    request = QgsFeatureRequest().setFilterExpression(e)
    return [f for f in layer.getFeatures(request)]
    
    
    
def featuresWithinGeometriesExp(geometries):
    def a(geom):
        return "contains(geom_from_wkt('{wkt}'),$geometry)".format(wkt=geom.asWkt())
    
    return ' or '.join([a(geom) for geom in geometries])
    
def featuresWithinGeometries(geometries,layer):
    e = featuresWithinGeometriesExp(geometries)
    request = QgsFeatureRequest().setFilterExpression(e)
    return [f for f in layer.getFeatures(request)]


def testFeaturesWithinGeometriesExp():
    wkt = 'MultiPolygon (((428008.96670920855831355 556547.6327252727933228, 427991.66009090177249163 556567.86372722766827792, 427966.64457136340206489 556594.01728575560264289, 427945.4679508043336682 556612.45301379729062319, 427924.54182121495250612 556627.97141262516379356, 427880.72995166887994856 556672.64801481540780514, 427852.86821697372943163 556728.67660069942940027, 427843.68391784554114565 556790.5727019167970866, 427854.07607747381553054 556852.27749682497233152, 427883.02743886772077531 556907.75089017546270043, 427927.70404105796478689 556951.56275972165167332, 427983.73262694198638201 556979.42449441680219024, 428045.62872815935406834 556988.60879354493226856, 428107.33352306741289794 556978.21663391659967601, 428162.80691641801968217 556949.26527252281084657, 428190.01954760152148083 556929.08492994878906757, 428202.20901830715592951 556919.28403908526524901, 428236.18101830722298473 556889.70903908531181514, 428249.38993235828820616 556877.1048518093302846, 428284.55993235821370035 556840.33485180931165814, 428292.00734496861696243 556832.10293293045833707, 428320.38434496859554201 556798.93093293043784797, 428334.2595127378590405 556780.69135524902958423, 428348.0819387633819133 556760.18056859378702939, 428374.50342930457554758 556703.45858402014710009, 428382.1037028661230579 556641.3480813802452758, 428370.13879171753069386 556579.92886942182667553, 428339.77990472648525611 556525.21308854420203716, 428293.99878127448027954 556482.55670060683041811, 428237.2767967008985579 556456.13521006563678384, 428175.16629406099673361 556448.53493650408927351, 428113.74708210257813334 556460.49984765273984522, 428059.03130122489528731 556490.85873464378528297, 428016.37491328758187592 556536.63985809567384422, 428008.96670920855831355 556547.6327252727933228)))'
    geoms = [QgsGeometry().fromWkt(wkt),QgsGeometry().fromWkt(wkt)]
    print(featuresWithinGeometriesExp(geoms))
    
def testFeaturesWithinGeometries():
    wkt = 'MultiPolygon (((428008.96670920855831355 556547.6327252727933228, 427991.66009090177249163 556567.86372722766827792, 427966.64457136340206489 556594.01728575560264289, 427945.4679508043336682 556612.45301379729062319, 427924.54182121495250612 556627.97141262516379356, 427880.72995166887994856 556672.64801481540780514, 427852.86821697372943163 556728.67660069942940027, 427843.68391784554114565 556790.5727019167970866, 427854.07607747381553054 556852.27749682497233152, 427883.02743886772077531 556907.75089017546270043, 427927.70404105796478689 556951.56275972165167332, 427983.73262694198638201 556979.42449441680219024, 428045.62872815935406834 556988.60879354493226856, 428107.33352306741289794 556978.21663391659967601, 428162.80691641801968217 556949.26527252281084657, 428190.01954760152148083 556929.08492994878906757, 428202.20901830715592951 556919.28403908526524901, 428236.18101830722298473 556889.70903908531181514, 428249.38993235828820616 556877.1048518093302846, 428284.55993235821370035 556840.33485180931165814, 428292.00734496861696243 556832.10293293045833707, 428320.38434496859554201 556798.93093293043784797, 428334.2595127378590405 556780.69135524902958423, 428348.0819387633819133 556760.18056859378702939, 428374.50342930457554758 556703.45858402014710009, 428382.1037028661230579 556641.3480813802452758, 428370.13879171753069386 556579.92886942182667553, 428339.77990472648525611 556525.21308854420203716, 428293.99878127448027954 556482.55670060683041811, 428237.2767967008985579 556456.13521006563678384, 428175.16629406099673361 556448.53493650408927351, 428113.74708210257813334 556460.49984765273984522, 428059.03130122489528731 556490.85873464378528297, 428016.37491328758187592 556536.63985809567384422, 428008.96670920855831355 556547.6327252727933228)))'
    geoms = [QgsGeometry().fromWkt(wkt),QgsGeometry().fromWkt(wkt)]
    print(featuresWithinGeometries(geoms,layer))

    
if __name__ =='__console__':
    wkt = 'MultiPolygon (((428008.96670920855831355 556547.6327252727933228, 427991.66009090177249163 556567.86372722766827792, 427966.64457136340206489 556594.01728575560264289, 427945.4679508043336682 556612.45301379729062319, 427924.54182121495250612 556627.97141262516379356, 427880.72995166887994856 556672.64801481540780514, 427852.86821697372943163 556728.67660069942940027, 427843.68391784554114565 556790.5727019167970866, 427854.07607747381553054 556852.27749682497233152, 427883.02743886772077531 556907.75089017546270043, 427927.70404105796478689 556951.56275972165167332, 427983.73262694198638201 556979.42449441680219024, 428045.62872815935406834 556988.60879354493226856, 428107.33352306741289794 556978.21663391659967601, 428162.80691641801968217 556949.26527252281084657, 428190.01954760152148083 556929.08492994878906757, 428202.20901830715592951 556919.28403908526524901, 428236.18101830722298473 556889.70903908531181514, 428249.38993235828820616 556877.1048518093302846, 428284.55993235821370035 556840.33485180931165814, 428292.00734496861696243 556832.10293293045833707, 428320.38434496859554201 556798.93093293043784797, 428334.2595127378590405 556780.69135524902958423, 428348.0819387633819133 556760.18056859378702939, 428374.50342930457554758 556703.45858402014710009, 428382.1037028661230579 556641.3480813802452758, 428370.13879171753069386 556579.92886942182667553, 428339.77990472648525611 556525.21308854420203716, 428293.99878127448027954 556482.55670060683041811, 428237.2767967008985579 556456.13521006563678384, 428175.16629406099673361 556448.53493650408927351, 428113.74708210257813334 556460.49984765273984522, 428059.03130122489528731 556490.85873464378528297, 428016.37491328758187592 556536.63985809567384422, 428008.96670920855831355 556547.6327252727933228)))'
    geom = QgsGeometry().fromWkt(wkt)
    layer = QgsProject.instance().mapLayersByName('stats19')[0]

    print(containedFeatures(geom,layer))
    testFeaturesWithinGeometries()
